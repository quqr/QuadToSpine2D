<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:suki="https://github.com/kikipoulet/SukiUI"
             xmlns:paz="using:Avalonia.Controls.PanAndZoom"
             mc:Ignorable="d"
             d:DesignWidth="1600"
             d:DesignHeight="1000"
             x:Class="QTSAvalonia.Views.Pages.Player"
             xmlns:pages="clr-namespace:QTSAvalonia.ViewModels.Pages"
             xmlns:userControlVMs="clr-namespace:QTSAvalonia.ViewModels.UserControls"
             xmlns:fluent="clr-namespace:FluentIcons.Avalonia.Fluent;assembly=FluentIcons.Avalonia.Fluent"
             xmlns:converters="clr-namespace:Avalonia.Markup.Xaml.Converters;assembly=Avalonia.Markup.Xaml"
             x:DataType="pages:PlayerViewModel">

    <Design.DataContext>
        <pages:PlayerViewModel />
    </Design.DataContext>
    <UserControl.Resources>
        <converters:ColorToBrushConverter x:Key="ColorToBrushConverter"/>
    </UserControl.Resources>
    <UserControl.Styles>
        <!-- 虚线坐标轴 -->
        <Style Selector="Path.dashed-axis">
            <Setter Property="StrokeDashArray" Value="2,2" />
            <Setter Property="StrokeThickness" Value="1" />
            <Setter Property="Stroke" Value="#D0D0D0" />
            <Setter Property="VerticalAlignment" Value="Center" />
            <Setter Property="HorizontalAlignment" Value="Center" />
            <Setter Property="Opacity" Value="0.6" />
        </Style>

        <!-- 按钮 -->
        <Style Selector="Button">
            <Setter Property="FontSize" Value="13" />
            <Setter Property="FontWeight" Value="Medium" />
            <Setter Property="Padding" Value="14,10" />
        </Style>

        <Style Selector="Button.icon-button">
            <Setter Property="Width" Value="50" />
            <Setter Property="Height" Value="50" />
            <Setter Property="HorizontalContentAlignment" Value="Center" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
        </Style>

        <Style Selector="Button.list-item">
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Padding" Value="10,8" />
            <Setter Property="Margin" Value="0,2,0,2" />
        </Style>

        <!-- 文本块 -->
        <Style Selector="TextBlock">
            <Setter Property="FontSize" Value="13" />
            <Setter Property="VerticalAlignment" Value="Center" />
        </Style>

        <Style Selector="TextBlock.title-large">
            <Setter Property="FontSize" Value="18" />
            <Setter Property="FontWeight" Value="SemiBold" />
        </Style>

        <Style Selector="TextBlock.label">
            <Setter Property="FontSize" Value="12" />
            <Setter Property="FontWeight" Value="Medium" />
        </Style>

        <Style Selector="TextBlock.column-header">
            <Setter Property="FontSize" Value="11" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="TextAlignment" Value="Center" />
        </Style>

        <Style Selector="TextBlock.subtitle">
            <Setter Property="FontSize" Value="11" />
            <Setter Property="TextTrimming" Value="CharacterEllipsis" />
        </Style>

        <!-- 颜色选择器 -->
        <Style Selector="ColorPicker">
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Padding" Value="10,6" />
            <Setter Property="Margin" Value="4,2" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Height" Value="30" />
            <Setter Property="VerticalAlignment" Value="Center" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
            <Setter Property="HorizontalAlignment" Value="Center" />
            <Setter Property="HorizontalContentAlignment" Value="Center" />
            <Setter Property="CornerRadius" Value="5" />
        </Style>

        <!-- 切换按钮 -->
        <Style Selector="ToggleButton">
            <Setter Property="VerticalAlignment" Value="Center" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
            <Setter Property="HorizontalAlignment" Value="Center" />
            <Setter Property="HorizontalContentAlignment" Value="Center" />

            <Setter Property="FontSize" Value="12" />
            <Setter Property="Padding" Value="10,6" />
            <Setter Property="Margin" Value="4,2" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Height" Value="30" />
        </Style>

        <!-- 分割器 -->
        <Style Selector="GridSplitter">
            <Setter Property="Background" Value="#E5E7EB" />
            <Setter Property="CornerRadius" Value="2" />
            <Setter Property="Opacity" Value="0.4" />
        </Style>

        <Style Selector="GridSplitter:pointerover">
            <Setter Property="Background" Value="#2563EB" />
            <Setter Property="Opacity" Value="1" />
            <Setter Property="Cursor" Value="SizeWestEast" />
        </Style>

        <Style Selector="GridSplitter:pressed">
            <Setter Property="Background" Value="#1D4ED8" />
            <Setter Property="Opacity" Value="1" />
        </Style>

        <Style Selector="GridSplitter.vertical">
            <Setter Property="Cursor" Value="SizeNorthSouth" />
        </Style>

        <!-- 滑块 -->
        <Style Selector="Slider">
            <Setter Property="Margin" Value="6,0" />
            <Setter Property="VerticalAlignment" Value="Center" />
        </Style>
    </UserControl.Styles>

    <Grid RowDefinitions="*,4,Auto" ColumnDefinitions="*" Margin="12">
        <!-- 主预览区域 -->
        <Grid Grid.Row="0" ColumnDefinitions="1*,4,1.4*">
            <!-- 左侧: 对象面板 -->
            <suki:GlassCard Grid.Column="0" CornerRadius="12" Padding="0">
                <Grid RowDefinitions="Auto,*,Auto">
                    <!-- 头部 -->
                    <StackPanel Grid.Row="0" Spacing="8" Margin="16">
                        <TextBlock Text="Animation Objects" Classes="title-large" />
                        <Rectangle Height="1" Fill="#E5E7EB" />
                    </StackPanel>

                    <!-- 对象列表 -->
                    <Grid Grid.Row="1" ColumnDefinitions="1*,1*,1*,1*" RowDefinitions="Auto,*">
                        <!-- 列标题 -->
                        <Grid Grid.Row="0" Grid.ColumnSpan="4" ColumnDefinitions="1*,1*,1*,1*">
                            <TextBlock Grid.Column="0" Text="Skeletons" Classes="column-header" Margin="4,8,4,4" />
                            <TextBlock Grid.Column="1" Text="Animations" Classes="column-header" Margin="4,8,4,4" />
                            <TextBlock Grid.Column="2" Text="Keyframes" Classes="column-header" Margin="4,8,4,4" />
                            <TextBlock Grid.Column="3" Text="Layers" Classes="column-header" Margin="4,8,4,4" />
                        </Grid>

                        <!-- 列表模板 -->
                        <ScrollViewer Grid.Row="1" Grid.Column="0" Margin="8,4,4,8">
                            <ItemsControl ItemsSource="{Binding Skeletons}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Spacing="4" />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Classes="list-item"
                                                Content="{Binding Content}"
                                                Command="{Binding Command}"
                                                CommandParameter="{Binding CommandParameter}" />
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>

                        <ScrollViewer Grid.Row="1" Grid.Column="1" Margin="4,4,4,8">
                            <ItemsControl ItemsSource="{Binding Animations}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Spacing="4" />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Classes="list-item"
                                                Content="{Binding Content}"
                                                Command="{Binding Command}"
                                                CommandParameter="{Binding CommandParameter}" />
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>

                        <ScrollViewer Grid.Row="1" Grid.Column="2" Margin="4,4,4,8">
                            <ItemsControl ItemsSource="{Binding Keyframes}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Spacing="4" />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Classes="list-item"
                                                Content="{Binding Content}"
                                                Command="{Binding Command}"
                                                CommandParameter="{Binding CommandParameter}" />
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>

                        <ScrollViewer Grid.Row="1" Grid.Column="3" Margin="4,4,8,8">
                            <ItemsControl ItemsSource="{Binding Layers}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Spacing="4" />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Classes="list-item"
                                                Content="{Binding Content}"
                                                Command="{Binding Command}"
                                                CommandParameter="{Binding CommandParameter}" />
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Grid>

                    <!-- 属性编辑区 -->
                    <Grid Grid.Row="2" RowDefinitions="Auto,Auto" ColumnDefinitions="Auto,*" Margin="12,8,12,12">
                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Colorize:" Classes="label"
                                   VerticalAlignment="Center" Margin="0,0,12,0" />
                        <ScrollViewer Grid.Row="0" Grid.Column="1" HorizontalScrollBarVisibility="Auto"
                                      VerticalScrollBarVisibility="Disabled" Height="50" MaxHeight="50">
                            <ItemsControl ItemsSource="{Binding Colorize}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal" />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                            </ItemsControl>
                        </ScrollViewer>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Attributes:" Classes="label"
                                   VerticalAlignment="Top" Margin="0,8,12,0" />
                        <ScrollViewer Grid.Row="1" Grid.Column="1" HorizontalScrollBarVisibility="Auto"
                                      VerticalScrollBarVisibility="Disabled" Height="46" MaxHeight="46"
                                      Margin="0,8,0,0">
                            <ItemsControl ItemsSource="{Binding Attributes}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal" />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                            </ItemsControl>
                        </ScrollViewer>
                    </Grid>
                </Grid>
            </suki:GlassCard>

            <!-- 分割条 -->
            <GridSplitter Grid.Column="1" Width="4" HorizontalAlignment="Center" VerticalAlignment="Stretch" />

            <!-- 右侧: 预览区域 -->
            <suki:GlassCard Grid.Column="2" CornerRadius="12" Padding="0">
                <Grid RowDefinitions="*,Auto">
                    <!-- 预览画布 -->
                    <paz:ZoomBorder
                        Stretch="None"
                        ZoomSpeed="1.08"
                        ClipToBounds="True"
                        Focusable="True"
                        VerticalAlignment="Stretch"
                        HorizontalAlignment="Stretch"
                        MinZoomX="0.05"
                        MinZoomY="0.05"
                        MaxZoomX="10"
                        MaxZoomY="10">
                        <Grid>
                            <Border Background="{userControlVMs:ChessboardBackground}" Width="20000" Height="20000" />
                            <Path ZIndex="10" Classes="dashed-axis">
                                <Path.Data>
                                    <LineGeometry StartPoint="-20000,0" EndPoint="20000,0" />
                                </Path.Data>
                            </Path>
                            <Path ZIndex="10" Classes="dashed-axis">
                                <Path.Data>
                                    <LineGeometry StartPoint="0,-20000" EndPoint="0,20000" />
                                </Path.Data>
                            </Path>
                            <Border ZIndex="1000" HorizontalAlignment="Center" VerticalAlignment="Center">
                                <Image Source="{Binding Image}" />
                            </Border>
                        </Grid>
                    </paz:ZoomBorder>

                    <!-- 控制条 -->
                    <Border Grid.Row="1" BorderThickness="0,1,0,0" Padding="16,12">
                        <StackPanel Spacing="10">
                            <Grid ColumnDefinitions="*,Auto">
                                <Slider Grid.Column="0" Value="{Binding CurrentFrame}" Minimum="0"
                                        Maximum="{Binding TotalFrames}" Margin="0,0,12,0" />
                                <TextBlock Grid.Column="1" MinWidth="70" TextAlignment="Right" FontSize="13">
                                    <TextBlock.Text>
                                        <MultiBinding StringFormat="{}{0:D4}/{1:D4}">
                                            <Binding Path="CurrentFrame" />
                                            <Binding Path="TotalFrames" />
                                        </MultiBinding>
                                    </TextBlock.Text>
                                </TextBlock>
                            </Grid>

                            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                                <Button Classes="icon-button" Command="{Binding SetPreviousFrameCommand}"
                                        ToolTip.Tip="Previous Frame">
                                    <fluent:FluentIcon Icon="Previous" FontSize="18" />
                                </Button>
                                <Button Classes="icon-button" Command="{Binding PlayAnimationCommand}"
                                        IsEnabled="{Binding !IsPlaying}" ToolTip.Tip="Play">
                                    <fluent:FluentIcon Icon="Play" FontSize="18" />
                                </Button>
                                <Button Classes="icon-button" Command="{Binding StopPlaybackCommand}"
                                        IsEnabled="{Binding IsPlaying}" ToolTip.Tip="Stop">
                                    <fluent:FluentIcon Icon="Stop" FontSize="18" />
                                </Button>
                                <Button Classes="icon-button" Command="{Binding SetNextFrameCommand}"
                                        ToolTip.Tip="Next Frame">
                                    <fluent:FluentIcon Icon="Next" FontSize="18" />
                                </Button>
                                <ToggleButton Classes="icon-button"
                                              IsChecked="{Binding IsLoopAnimation}"
                                        ToolTip.Tip="Loop animation">
                                    <fluent:FluentIcon Icon="ArrowSync" FontSize="18" />
                                </ToggleButton>
                                <Separator Width="1" Margin="4,0" Opacity="0.3" />
                                <Button Classes="icon-button" Command="{Binding QuicklyLoadCommand}"
                                        ToolTip.Tip="Quick Load">
                                    <fluent:FluentIcon Icon="ArrowSync" FontSize="18" />
                                </Button>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </Grid>
            </suki:GlassCard>
        </Grid>

        <!-- 分割条 -->
        <GridSplitter Grid.Row="1" Height="4" Classes="vertical" />

        <!-- 底部文件操作区 -->
        <suki:GlassCard Grid.Row="2" CornerRadius="12" Padding="16">
            <Grid ColumnDefinitions="Auto,Auto,Auto,Auto,*" VerticalAlignment="Center">
                <Button Grid.Column="0" Content="Select Quad" Command="{Binding OpenQuadFilePickerCommand}"
                        MinWidth="140" ToolTip.Tip="Browse and select a Quad animation file" />
                <Button Grid.Column="1" Content="Select Images" Command="{Binding OpenImageFilePickerCommand}"
                        Margin="12,0,0,0" MinWidth="140" ToolTip.Tip="Browse and select image texture files" />
                <Button Grid.Column="2" Content="Load" Command="{Binding LoadCommand}" Margin="12,0,0,0" MinWidth="100"
                        ToolTip.Tip="Load selected Quad file and images" />
                <Button Grid.Column="3" Content="Clear" Command="{Binding ClearCommand}" Margin="12,0,0,0"
                        MinWidth="100" ToolTip.Tip="Clear all loaded data" />
        
                <Border Grid.Column="4" Margin="24,0,0,0">
                    <StackPanel Spacing="8">
                        <StackPanel Spacing="2">
                            <TextBlock Text="Quad File:" Classes="label" />
                            <TextBlock Text="{Binding QuadFileName}" Classes="subtitle" Height="18" Margin="4,0,0,0" />
                        </StackPanel>
                        <StackPanel Spacing="2">
                            <TextBlock Text="Image Files:" Classes="label" />
                            <ScrollViewer MaxHeight="80" VerticalScrollBarVisibility="Auto">
                                <ItemsControl ItemsSource="{Binding ImagePaths}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding}" Classes="subtitle" Margin="4,1,0,1" />
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </suki:GlassCard>
    </Grid>

</UserControl>